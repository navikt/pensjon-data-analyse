---
title: "Analyse av feilutbetalinger til døde alderspensjonister"
jupyter: python3
execute:
    echo: false
    warning: false
    include: true
format:
    dashboard:
        embed-resources: true
        code-copy: true
        theme: flatly
        scrolling: true
---

```{python}
#| include: false
import os
import json
import oracledb
import pandas as pd
from itables import show
from pathlib import Path
import plotly.express as px
from datetime import datetime
import plotly.graph_objects as go
from google.cloud import secretmanager
```

```{python}
# | include: false

# henter data
def find_git_root(start_path=None):
    if start_path is None:
        start_path = Path.cwd()  # Use current working directory instead of __file__
    current_path = Path(start_path).resolve()
    while current_path != current_path.parent:
        if (current_path / ".git").is_dir():
            return current_path
        current_path = current_path.parent
    return None


git_root = find_git_root()
with open(git_root / "data" / "hemmelighet_navn", "r", encoding="utf-8") as f:
    hemmelighet = f.read().strip()
secret_name = f"projects/230094999443/secrets/{hemmelighet}/versions/latest"
client = secretmanager.SecretManagerServiceClient()
response = client.access_secret_version(request={"name": secret_name})
secret = json.loads(response.payload.data.decode("UTF-8"))
connection_pen = oracledb.connect(
    user=secret.get("DB_USER"),
    host=secret.get("DB_HOST"),
    port=secret.get("DB_PORT"),
    password=secret.get("DB_PASSWORD"),
    service_name=secret.get("DB_SERVICE_NAME"),
)

sql_path = git_root / "sql" / "feilutbetalinger_alderspensjonister" / "feilutbetalinger_per_mnd.sql"
with open(sql_path, "r", encoding="utf-8") as f:
    base_sql = f.read()
sql_path_dodsfall = git_root / "sql" / "feilutbetalinger_alderspensjonister" / "dodsfall_fra_t_person.sql"
with open(sql_path_dodsfall, "r", encoding="utf-8") as f:
    sql_dodsfall_persontabell = f.read()

with connection_pen.cursor() as cursor:
    cursor.execute(base_sql)
    columns = [col[0].lower() for col in cursor.description]
    data = cursor.fetchall()
    cursor.execute(sql_dodsfall_persontabell)
    columns_dodsfall = [col[0].lower() for col in cursor.description]
    dodsfall_data = cursor.fetchall()

connection_pen.close()
df = pd.DataFrame(data, columns=columns)
df_dodsfall = pd.DataFrame(dodsfall_data, columns=columns_dodsfall)
print("Kolonner i df:\n" + "\n".join(f"- {col}" for col in df.columns))
print("Unike bostedsland i df:\n" + "\n".join(f"- {land}" for land in df["bosatt"].unique()))
df['Prosent saker med tilbakekreving'] = round((df['antall_saker_med_tilbakekreving'] / df['antall_saker_totalt'] ) * 100, 1)

df_arlig = df.groupby("dod_ar").sum(numeric_only=True).reset_index()
df_arlig['Prosent saker med tilbakekreving'] = round((df_arlig['antall_saker_med_tilbakekreving'] / df_arlig['antall_saker_totalt'] ) * 100, 1)
```


```{python}
#| include: false

fig_arlig = go.Figure()
fig_arlig.add_trace(go.Bar(
    x=df_dodsfall['dod_ar'],
    y=df_dodsfall['antall_dodsfall_alder'],
    name='Dødsfall med sak ALDER (t_person)',
    marker_color='grey'
))
for col in df_arlig.columns:
    if col != 'dod_ar':
        fig_arlig.add_trace(go.Bar(
            x=df_arlig['dod_ar'],
            y=df_arlig[col],
            name=col.replace('_', ' '),
            visible='legendonly' if col != 'antall_saker_totalt' else True
        ))
fig_arlig.update_layout(
    barmode='group',
    title_text='Feilutbetalinger per dødsår – (antall saker er opphørssaker på dødsfall)',
    xaxis_title='Dødsår',
    yaxis_title='Antall saker / dødsfall',
    legend_title='Trykk for å vise/skjule',
)
```

```{python}
#| include: false

fig_tilbakekrevinger_antall = px.bar(
    df,
    x="dod_ar",
    y='antall_saker_med_tilbakekreving',
    title="Antall opphørssaker ved dødsfall med påfølgende tilbakekreving",
    color="bosatt",
    hover_name="bosatt",
    hover_data=["dod_ar", "antall_saker_med_tilbakekreving", "sum_tilbakekreving", "Prosent saker med tilbakekreving"],
    labels={"dod_ar": "Dødsår", "sum_tilbakekreving": "Sum av mnd tilbakekrevd", "antall_saker_med_tilbakekreving": "Antall saker med tilbakekreving"}
)
fig_tilbakekrevinger_sum = px.bar(
    df,
    x="dod_ar",
    y='sum_tilbakekreving',
    title="Sum måneder tilbakekrevd",
    color="bosatt",
    hover_name="bosatt",
    hover_data=["dod_ar", "antall_saker_med_tilbakekreving", "sum_tilbakekreving", "Prosent saker med tilbakekreving"],
    labels={"dod_ar": "Dødsår", "sum_tilbakekreving": "Sum av mnd tilbakekrevd", "antall_saker_med_tilbakekreving": "Antall saker med tilbakekreving"}
)
fig_tilbakekrevinger_prosent = px.bar(
    df,
    x="dod_ar",
    y='Prosent saker med tilbakekreving',
    title="Prosent saker med tilbakekreving",
    color="bosatt",
    barmode="group", # kun denne er group
    hover_name="bosatt",
    hover_data=["dod_ar", "antall_saker_med_tilbakekreving", "sum_tilbakekreving", "Prosent saker med tilbakekreving"],
    labels={"dod_ar": "Dødsår", "sum_tilbakekreving": "Sum av mnd tilbakekrevd", "antall_saker_med_tilbakekreving": "Antall saker med tilbakekreving"}
)

fig_tilbakekrevinger_sum
fig_tilbakekrevinger_antall
fig_tilbakekrevinger_prosent
```


# plott


```{python}
fig_arlig
```

```{python}
fig_tilbakekrevinger_antall
```

```{python}
fig_tilbakekrevinger_sum
```

```{python}
fig_tilbakekrevinger_prosent
```


# tabell per år

```{python}
show(df_arlig, paging=False)
```

# tabell per år og bosted

```{python}
show(df, paging=False)
```

# sql

```{python}
print(base_sql)
```

# om

```{python}
print(f"""
Denne datafortellingen viser en initiell analyse av feilutbetalinger til døde alderspensjonister. 
Dataene her er hentet {datetime.now().strftime("%d.%m.%Y")} og vil utvikle seg over tid med flere registrerte dødsfall tilbake i tid.
I fanen "sql" kan du se sql-spørringen som er kjørt mot pen. Denne er aggregert på litt ulik vis for å få til plottene under.
""")
```
